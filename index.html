<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ChatterLink - Demo</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f0f0f0; }
  #app { max-width: 600px; margin: auto; }
  .room-link { display: block; margin: 10px 0; color: blue; cursor: pointer; text-decoration: underline; }
  #setup-popup {
    position: fixed; top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: white; padding: 20px; border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    display: none;
    width: 300px;
  }
  #setup-popup label { display: block; margin-top: 10px; font-weight: bold; }
  #setup-popup input, #setup-popup textarea, #setup-popup select {
    width: 100%; padding: 6px; margin-top: 4px; box-sizing: border-box;
  }
  #setup-popup button {
    margin-top: 15px; padding: 8px 12px; font-weight: bold;
    cursor: pointer;
  }
  #save-btn { background-color: #28a745; color: white; border: none; margin-right: 10px; }
  #cancel-btn { background-color: #dc3545; color: white; border: none; }
  #login-status { margin-bottom: 20px; }
</style>
</head>
<body>
<div id="app">
  <h1>Welcome to ChatterLink Demo</h1>
  <div id="login-status">Checking login status...</div>

  <button id="sign-in-google">Sign In with Google</button>
  <button id="sign-out" style="display:none;">Sign Out</button>

  <h2>Rooms</h2>
  <a href="#" class="room-link" data-room-id="room1">Join Room 1</a>
  <a href="#" class="room-link" data-room-id="room2">Join Room 2</a>
  <a href="#" class="room-link" data-room-id="room3">Join Room 3</a>
</div>

<!-- Setup Account Popup -->
<div id="setup-popup">
  <h3>Set Up Your Account</h3>
  <label for="username">Username:</label>
  <input type="text" id="username" placeholder="Your username" />

  <label for="bio">Bio:</label>
  <textarea id="bio" rows="3" placeholder="Tell us about yourself"></textarea>

  <label for="location">Location:</label>
  <input type="text" id="location" placeholder="Where are you from?" />

  <label for="status">Status:</label>
  <select id="status">
    <option value="online">Online</option>
    <option value="idle">Idle</option>
    <option value="dnd">Do Not Disturb</option>
    <option value="offline">Offline</option>
  </select>

  <div style="margin-top:15px; text-align:right;">
    <button id="save-btn">Save</button>
    <button id="cancel-btn">Cancel</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCm1cAUqlA-w2rp5aoDYJEj_sGPqa0SjGs",
    authDomain: "chatterlink-2b1b0.firebaseapp.com",
    projectId: "chatterlink-2b1b0",
    storageBucket: "chatterlink-2b1b0.firebasestorage.app",
    messagingSenderId: "103060805767",
    appId: "1:103060805767:web:f1418d6c691bb1a7070022",
    measurementId: "G-83ZPCY37ST"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // UI Elements
  const loginStatus = document.getElementById('login-status');
  const signInBtn = document.getElementById('sign-in-google');
  const signOutBtn = document.getElementById('sign-out');

  const setupPopup = document.getElementById('setup-popup');
  const saveBtn = document.getElementById('save-btn');
  const cancelBtn = document.getElementById('cancel-btn');
  const usernameInput = document.getElementById('username');
  const bioInput = document.getElementById('bio');
  const locationInput = document.getElementById('location');
  const statusSelect = document.getElementById('status');

  let currentUser = null;

  // Sign in with Google
  signInBtn.addEventListener('click', async () => {
    const provider = new GoogleAuthProvider();
    try {
      await signInWithPopup(auth, provider);
      // onAuthStateChanged will handle UI updates
    } catch (error) {
      alert("Failed to sign in: " + error.message);
    }
  });

  // Sign out
  signOutBtn.addEventListener('click', async () => {
    await signOut(auth);
  });

  // Handle auth state changes
  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    if (user) {
      loginStatus.textContent = `Signed in as: ${user.email}`;
      signInBtn.style.display = "none";
      signOutBtn.style.display = "inline-block";

      // Check if user has setup data
      const userDocRef = doc(db, "users", user.uid);
      const userDocSnap = await getDoc(userDocRef);

      if (!userDocSnap.exists()) {
        // Show setup popup if no data
        showSetupPopup();
      } else {
        // Optionally load user data into UI here
        hideSetupPopup();
      }
    } else {
      loginStatus.textContent = "Not signed in";
      signInBtn.style.display = "inline-block";
      signOutBtn.style.display = "none";
      hideSetupPopup();
    }
  });

  function showSetupPopup() {
    setupPopup.style.display = 'block';
  }

  function hideSetupPopup() {
    setupPopup.style.display = 'none';
  }

  saveBtn.addEventListener('click', async () => {
    if (!currentUser) {
      alert("You must be signed in to save your profile.");
      return;
    }
    const username = usernameInput.value.trim();
    if (!username) {
      alert("Username cannot be empty.");
      return;
    }
    const bio = bioInput.value.trim();
    const location = locationInput.value.trim();
    const status = statusSelect.value;

    // Save to Firestore
    try {
      await setDoc(doc(db, "users", currentUser.uid), {
        username,
        bio,
        location,
        status
      });
      alert("Profile saved!");
      hideSetupPopup();
    } catch (err) {
      alert("Failed to save profile: " + err.message);
    }
  });

  cancelBtn.addEventListener('click', () => {
    hideSetupPopup();
  });

  // Room joining logic: Only join if signed in
  document.querySelectorAll('.room-link').forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      if (!currentUser) {
        alert("You must sign in to join a room.");
        return;
      }
      const roomId = link.dataset.roomId;
      alert(`Joining room: ${roomId}`); 
      // Replace alert with your room join logic
    });
  });
</script>
</body>
</html>
